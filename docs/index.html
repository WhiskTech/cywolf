<!DOCTYPE html>

<html>
<head>
  <title>index.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="index.html">
                index.js
              </a>
            
              
              <a class="source" href="villager.html">
                villager.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>index.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <pre><code>Cywolf: evented, modular wolfgame for node
Created by whiskers75 - http://whiskers75.com
This module is licensed under the ISC License.
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">'util'</span>);
<span class="hljs-keyword">var</span> Chance = <span class="hljs-built_in">require</span>(<span class="hljs-string">'chance'</span>);
<span class="hljs-keyword">var</span> _ = <span class="hljs-built_in">require</span>(<span class="hljs-string">'underscore'</span>);
<span class="hljs-keyword">var</span> chance = <span class="hljs-keyword">new</span> Chance();
<span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
<span class="hljs-keyword">var</span> coffee = <span class="hljs-built_in">require</span>(<span class="hljs-string">'coffee-script'</span>);
<span class="hljs-keyword">var</span> EventEmitter = <span class="hljs-built_in">require</span>(<span class="hljs-string">'events'</span>).EventEmitter;
<span class="hljs-keyword">var</span> Wolfgame = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Options:</p>
<ul>
<li>irc (if you&#39;re using IRC)</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!options) {
	options = {irc: <span class="hljs-literal">false</span>};
    }
    <span class="hljs-keyword">this</span>.players = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Valid phases: start, day, night</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.phase = <span class="hljs-string">'start'</span>;
    <span class="hljs-keyword">this</span>.lynches = {};
    <span class="hljs-keyword">this</span>.dead = {};
    <span class="hljs-keyword">this</span>.over = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">this</span>.timeouts = [];
    <span class="hljs-keyword">if</span> (options.irc) {
	<span class="hljs-keyword">this</span>.bold = <span class="hljs-built_in">require</span>(<span class="hljs-string">'irc-colors'</span>).bold;
    }
    <span class="hljs-keyword">else</span> {
	<span class="hljs-keyword">this</span>.bold = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x)</span> {</span>
	    <span class="hljs-keyword">return</span> x;
	};
    }
    <span class="hljs-keyword">this</span>.Villager = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./roles/villager.js'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h2 id="internal-functions">Internal functions</h2>

            </div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p><code>Wolfgame.checkEnd()</code></p>
<p>Checks if the game is over yet. Return value: true/false</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.checkEnd = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
	<span class="hljs-keyword">var</span> wolves = <span class="hljs-number">0</span>;
	<span class="hljs-keyword">var</span> vills = <span class="hljs-number">0</span>;
	_.keys(process.game.players).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(player)</span> {</span>
	    <span class="hljs-keyword">if</span> (process.game.players[player].team == <span class="hljs-string">'wolf'</span>){
		wolves++;
	    }
	    <span class="hljs-keyword">else</span> {
		vills++;
	    }
	});
	<span class="hljs-keyword">if</span> (wolves &gt;= vills || vills == <span class="hljs-number">0</span>) {
	    process.game.emit(<span class="hljs-string">'gameover'</span>, {win: <span class="hljs-string">'wolves'</span>});
	    process.game.over = <span class="hljs-literal">true</span>;
	    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
	}
	<span class="hljs-keyword">if</span> (wolves == <span class="hljs-number">0</span>) {
	    process.game.emit(<span class="hljs-string">'gameover'</span>, {win: <span class="hljs-string">'villagers'</span>});
	    process.game.over = <span class="hljs-literal">true</span>;
	    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
	}
	<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p><code>Wolfgame.autocomplete(player, from)</code></p>
<p>Autocompletes <code>player</code>&#39;s username, with optional <code>from</code> to determine the recipient of error messages.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.autocomplete = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(player, from)</span> {</span>
        <span class="hljs-keyword">var</span> count = <span class="hljs-number">0</span>;
        _.keys(<span class="hljs-keyword">this</span>.players).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(p)</span> {</span>
            <span class="hljs-keyword">if</span> (p.indexOf(player) == <span class="hljs-number">0</span> || p.toLowerCase().indexOf(player) == <span class="hljs-number">0</span>) {
                player = p;
                count++;
            }
        });
        <span class="hljs-keyword">if</span> (_.keys(<span class="hljs-keyword">this</span>.players).indexOf(player) == -<span class="hljs-number">1</span>) {
            <span class="hljs-keyword">if</span> (from) {
                <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'notice'</span>, {to: from, message: <span class="hljs-string">'That player does not exist.'</span>});
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        <span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">1</span>) {
            <span class="hljs-keyword">if</span> (from) {
                <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'notice'</span>, {to: from, message: <span class="hljs-string">'Ambiguous autocompletion. Please refine!'</span>});
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        <span class="hljs-keyword">return</span> player;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p><code>Wolfgame.checkLynches()</code></p>
<p>Checks if the current lynches in <code>Wolfgame.lynches</code> are enough to kill someone, and if so, kills that person.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.checkLynches = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        <span class="hljs-keyword">var</span> votes = {};
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.phase !== <span class="hljs-string">'day'</span>) {
            <span class="hljs-keyword">return</span>;
        }
        _.keys(<span class="hljs-keyword">this</span>.lynches).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(lynch)</span> {</span>
            lynch = process.game.lynches[lynch];
            <span class="hljs-keyword">if</span> (!votes[lynch]) {
                votes[lynch] = <span class="hljs-number">0</span>;
            }
            votes[lynch]++;
        });
        <span class="hljs-built_in">Object</span>.keys(votes).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(vote)</span> {</span>
            <span class="hljs-keyword">var</span> voted = votes[vote];
            <span class="hljs-keyword">if</span> (voted &gt;= (_.keys(process.game.players).length - (_.keys(process.game.players).length &gt; <span class="hljs-number">4</span> ? <span class="hljs-number">2</span> : <span class="hljs-number">1</span>))) {
                <span class="hljs-keyword">if</span> (!process.game.kill(vote, <span class="hljs-string">' was lynched by the angry mob of villagers.'</span>)) {
                    process.game.emit(<span class="hljs-string">'night'</span>);
                }
                <span class="hljs-keyword">return</span>;
            }
        });
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p><code>Wolfgame.randomUPlayer()</code></p>
<p>Returns a random unallocated player. Only really useful for allocation.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.randomUPlayer = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        <span class="hljs-keyword">var</span> roled = [];
        _.keys(<span class="hljs-keyword">this</span>.players).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(player)</span> {</span>
            player = process.game.players[player];
            <span class="hljs-keyword">if</span> (player != <span class="hljs-string">'unallocated'</span>) {
                roled.push(player);
                <span class="hljs-keyword">delete</span> process.game.players[player.name];
            }
        });
        <span class="hljs-keyword">var</span> chosen = _.keys(<span class="hljs-keyword">this</span>.players)[chance.integer({min: <span class="hljs-number">0</span>, max: _.keys(<span class="hljs-keyword">this</span>.players).length - <span class="hljs-number">1</span>})];
        roled.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(p)</span> {</span>
            process.game.players[p.name] = p;
        });
        <span class="hljs-keyword">return</span> chosen;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <h2 id="external-functions">External functions</h2>

            </div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p><code>Wolfgame.randomPlayer()</code></p>
<p>Returns a random player.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.randomPlayer = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        <span class="hljs-keyword">return</span> _.keys(<span class="hljs-keyword">this</span>.players)[chance.integer({min: <span class="hljs-number">0</span>, max: _.keys(<span class="hljs-keyword">this</span>.players).length - <span class="hljs-number">1</span>})];
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p><code>Wolfgame.lynch(player, lynchee)</code></p>
<p>Makes <code>lynchee</code> vote for <code>player</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.lynch = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(player, lynchee)</span> {</span>
        <span class="hljs-keyword">if</span> (process.game.autocomplete(player) &amp;&amp; process.game.autocomplete(lynchee)) {
            lynchee = process.game.autocomplete(lynchee);
            player = process.game.autocomplete(player);
            process.game.lynches[lynchee] = player;
            process.game.emit(<span class="hljs-string">'lynch'</span>, {from: lynchee, to: player});
            process.game.checkLynches();
        }
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p><code>Wolfgame.pm(to, message)</code></p>
<p>Message <code>to</code> with <code>message</code>. </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.pm = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(to, message)</span> {</span>
        <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'pm'</span>, {to: to, message: message});
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p><code>Wolfgame.kill()</code></p>
<p>Kills a player, with optional <code>reason</code>, and <code>hooks</code>.
Hooks format: <code>hooks = {after: function() {}};</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.kill = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(player, reason, hooks)</span> {</span>
	<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> hooks == <span class="hljs-string">'undefined'</span>) {
	    hooks = <span class="hljs-literal">false</span>;
	}
	<span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'death'</span>, {player: player, reason: reason, role: <span class="hljs-keyword">this</span>.players[player]});
	<span class="hljs-keyword">this</span>.dead[player] = <span class="hljs-keyword">this</span>.players[player];
        <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.players[player];
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.phase !== <span class="hljs-string">'start'</span>) {
	    <span class="hljs-keyword">var</span> end = <span class="hljs-keyword">this</span>.checkEnd();
	    <span class="hljs-keyword">if</span> (!end) {
		<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.dead[player].onDeath) {
		    player.onDeath(<span class="hljs-keyword">this</span>, player.name);
		}
		_.keys(<span class="hljs-keyword">this</span>.players).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(p)</span> {</span>
		    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> p == <span class="hljs-string">'undefined'</span>) {
			<span class="hljs-keyword">return</span>;
		    }
		    p = process.game.players[p];
                    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> p == <span class="hljs-string">'undefined'</span>) {
                        <span class="hljs-keyword">return</span>;
                    }
		    <span class="hljs-keyword">if</span> (p.onOtherDeath) {
			p.onOtherDeath(process.game, player.name);
		    }
		});
		<span class="hljs-keyword">if</span> (hooks) {
		    hooks.after(<span class="hljs-keyword">this</span>, player);
		}
	    }
	    <span class="hljs-keyword">return</span> end;
        }
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p><code>Wolfgame.listRoles(callback);</code></p>
<p>Lists roles, calling <code>callback</code> with a string of roles.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    
    <span class="hljs-keyword">this</span>.listRoles = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(cb)</span> {</span>
        fs.readdir(__dirname + <span class="hljs-string">'/roles'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, roles)</span> {</span>
            <span class="hljs-keyword">if</span> (err) { <span class="hljs-comment">// We're screwed</span>
                <span class="hljs-keyword">throw</span> err;
            }
            <span class="hljs-keyword">var</span> ret = [];
            roles.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(role)</span> {</span>
                <span class="hljs-keyword">try</span> {
                    role = <span class="hljs-built_in">require</span>(__dirname + <span class="hljs-string">'/roles/'</span> + role);
                }
                <span class="hljs-keyword">catch</span>(e) {
                    console.log(<span class="hljs-string">'Error reading role: '</span> + role, err);
                    <span class="hljs-keyword">return</span>;
                }
                role = <span class="hljs-keyword">new</span> role(process.game);
                <span class="hljs-keyword">if</span> (!role.minPlayers) {
                    role.minPlayers = <span class="hljs-number">4</span>;
                }
		ret.push(role.toString() + <span class="hljs-string">' ['</span> + role.minPlayers + <span class="hljs-string">']'</span>);
            });
	    cb(ret.join(<span class="hljs-string">', '</span>));
	});
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p><code>Wolfgame.allocate()</code></p>
<p>Allocates roles.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.allocate = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
	process.game = <span class="hljs-keyword">this</span>;
	fs.readdir(__dirname + <span class="hljs-string">'/roles'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, roles)</span> {</span>
	    <span class="hljs-keyword">if</span> (err) { <span class="hljs-comment">// We're screwed</span>
		<span class="hljs-keyword">throw</span> err;
	    }
	    <span class="hljs-keyword">var</span> roled = [];
	    roles.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(role)</span> {</span>
		<span class="hljs-keyword">try</span> {
		    role = <span class="hljs-built_in">require</span>(__dirname + <span class="hljs-string">'/roles/'</span> + role);
		}
		<span class="hljs-keyword">catch</span>(e) {
		    console.log(<span class="hljs-string">'Error reading role: '</span> + role, err);
		    <span class="hljs-keyword">return</span>;
		}
		role = <span class="hljs-keyword">new</span> role(process.game);
		<span class="hljs-keyword">if</span> (role.toString() == <span class="hljs-string">'villager'</span>) {
		    <span class="hljs-keyword">return</span>;
		}
		<span class="hljs-keyword">if</span> (!role.minPlayers) {
		    role.minPlayers = <span class="hljs-number">0</span>;
		}
                console.log(<span class="hljs-string">'Loaded role: '</span> + role.toString() + <span class="hljs-string">' (requires '</span> + role.minPlayers + <span class="hljs-string">' players)'</span>);
		<span class="hljs-keyword">if</span> (_.keys(process.game.players).length &gt;= role.minPlayers) {
		    <span class="hljs-keyword">var</span> torole = process.game.randomUPlayer();
		    console.log(<span class="hljs-string">'Allocating role: '</span> + role.toString() + <span class="hljs-string">' to player '</span> + torole);
		    process.game.players[torole] = role;
		    process.game.players[torole].name = torole;
		    console.log(process.game.players[torole].toString());
		}
	    });
            <span class="hljs-keyword">var</span> defvil = <span class="hljs-keyword">new</span> process.game.Villager(<span class="hljs-keyword">this</span>);
            _.keys(process.game.players).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(player)</span> {</span>
                <span class="hljs-keyword">if</span> (process.game.players[player] == <span class="hljs-string">'unallocated'</span>) {
                    process.game.players[player] = defvil;
                    process.game.players[player].name = player;
                }
            });
            <span class="hljs-keyword">return</span> process.game.emit(<span class="hljs-string">'night'</span>);
	});
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <h2 id="events">Events</h2>

            </div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p><code>&#39;join&#39; {player: &#39;player&#39;}</code></p>
<p>Emit to join a player.</p>
<p><code>&#39;quitted&#39;, {player: &#39;player&#39;}</code></p>
<p>Emitted when a player joins.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.on(<span class="hljs-string">'join'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> {</span>
	<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.phase != <span class="hljs-string">'start'</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p><code>&#39;error&#39; instanceof Error</code></p>
<p>Emitted when an error is thrown. <strong>Have some code handling errors, or one error event will crash the game!</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'error'</span>, <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'You can\'t join or quit now!'</span>));
	}
	<span class="hljs-keyword">if</span> (_.keys(<span class="hljs-keyword">this</span>.players).indexOf(data.player) !== -<span class="hljs-number">1</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p><code>&#39;notice&#39;, {to: &#39;player&#39;, message: &#39;blah&#39;}</code></p>
<p>Emitted when Cywolf wants to send a notice to a player.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'notice'</span>, {to: data.player, message: <span class="hljs-string">'You are already playing.'</span>});
	}
	<span class="hljs-keyword">else</span> {
	    <span class="hljs-keyword">this</span>.players[data.player] = <span class="hljs-string">'unallocated'</span>;
	    <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'joined'</span>, {player: data.player});
	}
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p><code>&#39;quit&#39; {player: &#39;player&#39;}</code></p>
<p>Emit to quit a player.</p>
<p><code>&#39;quitted&#39; {player: &#39;player&#39;}</code></p>
<p>Emitted when a player quits.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.on(<span class="hljs-string">'quit'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> {</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.phase != <span class="hljs-string">'start'</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'error'</span>, <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'You can\'t join or quit now!'</span>));
        }
	<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.phase == <span class="hljs-string">'start'</span>) {
	    <span class="hljs-keyword">if</span> (_.keys(<span class="hljs-keyword">this</span>.players).indexOf(data.player) == -<span class="hljs-number">1</span>) {
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'notice'</span>, {to: data.player, message: <span class="hljs-string">'You are not playing.'</span>});
	    }
	    <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.players[data.player];
	    <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'quitted'</span>, {player: data.player});
	}
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p><code>&#39;start&#39;</code></p>
<p>Emit to start the game.</p>
<p><code>&#39;starting&#39;</code></p>
<p>Emitted when the game is starting.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.on(<span class="hljs-string">'start'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
	<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.phase != <span class="hljs-string">'start'</span>) {
	    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'error'</span>, <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'You can\'t start the game now!'</span>));
	}
	<span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'starting'</span>);
	<span class="hljs-keyword">this</span>.phase = <span class="hljs-string">'night'</span>;
	<span class="hljs-keyword">this</span>.allocate();
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p><code>&#39;night&#39;</code></p>
<p>Emitted when night starts. Note that the frontend is expected to handle roles!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.on(<span class="hljs-string">'night'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
	<span class="hljs-keyword">this</span>.phase = <span class="hljs-string">'night'</span>;
	<span class="hljs-keyword">this</span>.killing = <span class="hljs-string">''</span>;
	<span class="hljs-keyword">this</span>.timeouts.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(t)</span> {</span>
	    clearTimeout(t);
	});
	setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
	    process.game.timeouts.push(setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
		<span class="hljs-keyword">if</span> (process.game.phase == <span class="hljs-string">'night'</span>) {
		    process.game.emit(<span class="hljs-string">'day'</span>);
		}
	    }, <span class="hljs-number">120000</span>));
	}, <span class="hljs-number">1000</span>);
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p><code>day</code></p>
<p>Emitted when day starts.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.on(<span class="hljs-string">'day'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
	<span class="hljs-keyword">this</span>.phase = <span class="hljs-string">'day'</span>;
	<span class="hljs-keyword">this</span>.lynches = {};
        <span class="hljs-keyword">this</span>.timeouts.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(t)</span> {</span>
            clearTimeout(t);
        });
	_.keys(<span class="hljs-keyword">this</span>.players).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(p)</span> {</span>
	    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> p == <span class="hljs-string">'undefined'</span>) {
		<span class="hljs-keyword">return</span>;
	    }
	    p = process.game.players[p];
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> p == <span class="hljs-string">'undefined'</span>) {
                <span class="hljs-keyword">return</span>;
            }
	    <span class="hljs-keyword">if</span> (p.canAct) {
		p.acted = <span class="hljs-literal">false</span>;
	    }
	    <span class="hljs-keyword">if</span> (p.onDay) {
		p.onDay();
	    }
	});
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p><code>gameover</code></p>
<p>Emitted when the game ends.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.on(<span class="hljs-string">'gameover'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        <span class="hljs-keyword">this</span>.timeouts.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(t)</span> {</span>
            clearTimeout(t);
        });
    });
};
util.inherits(Wolfgame, EventEmitter);
module.exports = Wolfgame;</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
